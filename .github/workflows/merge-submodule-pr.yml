name: Merge Submodule PR

on:
  workflow_dispatch:
    inputs:
      base_pr_number:
        description: 'PR number from the base repo'
        required: true
      base_branch:
        description: 'Branch name from the base repo'
        required: true

permissions:
  pull-requests: write
  issues: write
  checks: write
  statuses: write

jobs:
  merge-submodule:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Submodule Repo
        uses: actions/checkout@v3
        with:
          repository: MOvenshire/submod
          ref: ${{ github.event.inputs.base_branch }}
          token: ${{ secrets.WORKFLOWS }}
          persist-credentials: false
          run: |
            echo "Checking out submodule repository..."
            echo "Repository: MOvenshire/submod"
            echo "Ref: ${{ github.event.inputs.base_branch }}"
            echo "Token: ${{ secrets.WORKFLOWS }}"
            echo "Checkout complete."
      - name: Find PR in Submodule Repo
        id: find_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.WORKFLOWS }}
          script: |
            console.log('Finding PR in submodule repository...');
            const branchName = '${{ github.event.inputs.base_branch }}';
            console.log(`Branch name: ${branchName}`);

            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${branchName}`
            });
            console.log(`Found ${prs.length} open PR(s) for branch ${branchName}`);

            if (prs.length === 0) {
              console.log(`No open PR found for branch ${branchName}`);
              return;
            }

            console.log(`PR found: #${prs[0].number} - ${prs[0].title}`);
            core.setOutput('pr_number', prs[0].number);
            console.log('Completed finding PR in submodule repository.');
      - name: Merge Submodule PR
        if: steps.find_pr.outputs.pr_number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.WORKFLOWS }}
          script: |
            console.log('Merging submodule PR...');
            const prNumber = '${{ steps.find_pr.outputs.pr_number }}';
            console.log(`Merging PR #${prNumber}`);
            
            await github.rest.pulls.merge({
              owner: 'MOvenshire',
              repo: 'submod',
              pull_number: parseInt(prNumber),
              merge_method: 'merge'
            });
            console.log(`PR #${prNumber} merged successfully.`);

            console.log(`Submodule PR #${prNumber} merged and closed.`);
            console.log('Completed merging submodule PR.');