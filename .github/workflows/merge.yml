name: Merge
on:
  workflow_dispatch:
    inputs:
      pr-number: { description: 'PR number', required: true }

jobs:
  merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout submodule repository
        uses: actions/checkout@v3
        with:
          repository: 'MOvenshire/submod'
          path: 'submodule'
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Merge PR
        run: |
          git fetch origin pull/${GITHUB_EVENT_NUMBER}/head:pr-${GITHUB_EVENT_NUMBER}
          git checkout pr-${GITHUB_EVENT_NUMBER}
          git merge --squash origin/main
          git commit -m "Merge PR #${GITHUB_EVENT_NUMBER}"
          git push origin HEAD:main --force
          curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -X POST https://api.github.com/repos/your-username/$GITHUB_REPOSITORY/actions/workflows/merge.yml/dispatches -d '{"ref":"main","inputs":{"pr-number":"'"$GITHUB_EVENT_NUMBER"'"}}'
          # Close the PR
          curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -X PATCH https://api.github.com/repos/your-username/$GITHUB_REPOSITORY/pulls/${GITHUB_EVENT_NUMBER} -d '{"state":"closed"}'