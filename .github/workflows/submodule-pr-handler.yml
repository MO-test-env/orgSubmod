name: Create Submodule PR (on /pr comment)

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write
  contents: write

env:
  # The secret must contain a PAT that can read/write **both** the base and submodule repos
  CROSS_TOKEN: ${{ secrets.WORKFLOWS }}

jobs:
  create-submodule-pr:
    if: |
      github.event.issue.pull_request != null &&
      github.event.comment.body == '/pr' &&
      github.event.comment.user.type != 'Bot'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout submodule repo (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ env.CROSS_TOKEN }}

      - name: Extract base PR metadata
        id: base_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.CROSS_TOKEN }}
          script: |
            const baseRepo = context.payload.repository.full_name; // e.g. owner/base
            const comment = context.payload.comment;
            const issue = context.payload.issue;
            const prNumber = issue.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: issue.user.login,
              repo: baseRepo.split('/')[1],
              pull_number: prNumber
            });
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_sha', pr.head.sha);
            core.setOutput('base_repo', baseRepo);

      - name: Create a branch that matches the base PR head ref
        id: new_branch
        run: |
          set -euo pipefail
          BRANCH="${{ steps.base_pr.outputs.head_ref }}"
          git checkout -b "$BRANCH"
          git push origin "$BRANCH"

      - name: Open PR in submodule repo
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.CROSS_TOKEN }}
          script: |
            const head = '${{ steps.new_branch.outputs.branch }}';
            const base = 'main'; // default branch – resolved dynamically below
            const repo = context.repo.repo;
            const owner = context.repo.owner;

            // Resolve default branch name (in case it isn’t “main”)
            const { data: repoInfo } = await github.rest.repos.get({owner, repo});
            const defaultBranch = repoInfo.default_branch || 'main';

            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              title: `Sync from base PR #${{ steps.base_pr.outputs.pr_number }}`,
              head,
              base: defaultBranch,
              body: `This PR syncs the submodule with the head of base PR #${{ steps.base_pr.outputs.pr_number }} from **${{ steps.base_pr.outputs.base_repo }}**.`
            });
            core.setOutput('pr_number', pr.number);
